<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Nakit Satis</title>
    <link href="../assets/dist/css/bundle.min.css" rel="stylesheet" type="text/css" />
    <link href="../assets/css/tebeos-theme.css" rel="stylesheet" type="text/css" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .window-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .window-toolbar {
            background: linear-gradient(180deg, #fafafa 0%, #e0e0e0 100%);
            border-bottom: 1px solid #bdbdbd;
            padding: 5px 10px;
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
        .window-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: #f5f5f5;
        }
        .products-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #bdbdbd;
            background: white;
        }
        .cart-panel {
            width: 380px;
            display: flex;
            flex-direction: column;
            background: white;
        }
        .search-bar {
            padding: 10px;
            background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%);
            border-bottom: 1px solid #90caf9;
        }
        .search-bar input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #bdbdbd;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-bar input:focus {
            border-color: #1976d2;
            outline: none;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }
        .category-tabs {
            display: flex;
            background: #e0e0e0;
            border-bottom: 1px solid #bdbdbd;
            overflow-x: auto;
            flex-shrink: 0;
        }
        .category-tab {
            padding: 8px 15px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 12px;
            white-space: nowrap;
        }
        .category-tab.active {
            background: white;
            border-bottom: 2px solid #1976d2;
        }
        .products-grid {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            background: white;
        }
        .product-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .product-card:hover {
            border-color: #1976d2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .product-card img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        .product-card .name {
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 5px;
            height: 30px;
            overflow: hidden;
        }
        .product-card .price {
            font-size: 13px;
            font-weight: 700;
            color: #1976d2;
        }
        .cart-header {
            background: linear-gradient(180deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 12px 15px;
            font-weight: 600;
        }
        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .cart-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            gap: 10px;
        }
        .cart-item .qty {
            width: 40px;
            text-align: center;
            font-weight: 600;
        }
        .cart-item .info {
            flex: 1;
        }
        .cart-item .info .name {
            font-size: 12px;
            font-weight: 500;
        }
        .cart-item .info .price {
            font-size: 11px;
            color: #666;
        }
        .cart-item .total {
            font-weight: 600;
            color: #1976d2;
        }
        .cart-item .remove {
            color: #e53935;
            cursor: pointer;
            padding: 5px;
        }
        .cart-summary {
            background: #f5f5f5;
            padding: 15px;
            border-top: 2px solid #1976d2;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .summary-row.total {
            font-size: 18px;
            font-weight: 700;
            color: #1976d2;
            border-top: 1px solid #bdbdbd;
            padding-top: 10px;
            margin-top: 10px;
        }
        .cart-actions {
            padding: 10px;
            display: flex;
            gap: 10px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }
        .cart-actions .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-pay {
            background: linear-gradient(180deg, #66bb6a 0%, #43a047 100%);
            color: white;
        }
        .btn-pay:hover {
            background: linear-gradient(180deg, #43a047 0%, #388e3c 100%);
        }
        .btn-hold {
            background: linear-gradient(180deg, #ffb74d 0%, #fb8c00 100%);
            color: white;
        }
        .btn-clear {
            background: linear-gradient(180deg, #ef5350 0%, #e53935 100%);
            color: white;
        }
        .window-statusbar {
            background: linear-gradient(180deg, #e0e0e0 0%, #bdbdbd 100%);
            padding: 4px 10px;
            font-size: 11px;
            color: #666;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #9e9e9e;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="window-container">
        <!-- Toolbar -->
        <div class="window-toolbar">
            <button class="tebeos-btn tebeos-btn-primary" id="btn-barcode">
                <i class="fa fa-barcode"></i> Barkod Oku
            </button>
            <button class="tebeos-btn tebeos-btn-success" id="btn-customer">
                <i class="fa fa-user"></i> Musteri Sec
            </button>
            <div style="flex:1"></div>
            <button class="tebeos-btn" id="btn-new-window" onclick="openNewPOS()">
                <i class="fa fa-plus"></i> Yeni Satis Penceresi
            </button>
        </div>

        <!-- Main Content -->
        <div class="window-content">
            <!-- Products Panel -->
            <div class="products-panel">
                <div class="search-bar">
                    <input type="text" id="product-search" placeholder="Urun ara (isim, barkod, kod)..." autofocus>
                </div>
                <div class="category-tabs" id="category-tabs">
                    <div class="category-tab active" data-category="all">Tumu</div>
                    <!-- Kategoriler JS ile yuklenecek -->
                </div>
                <div class="products-grid" id="products-grid">
                    <!-- Urunler yuklenecek -->
                </div>
            </div>

            <!-- Cart Panel -->
            <div class="cart-panel">
                <div class="cart-header">
                    <i class="fa fa-shopping-cart"></i> Sepet
                    <span id="cart-count" style="float:right; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px;">0</span>
                </div>
                <div class="cart-items" id="cart-items">
                    <!-- Sepet bosken -->
                    <div class="text-center text-muted p-20" id="empty-cart">
                        <i class="fa fa-shopping-cart fa-3x"></i>
                        <p>Sepet bos</p>
                    </div>
                </div>
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Ara Toplam:</span>
                        <span id="subtotal">0.00 TL</span>
                    </div>
                    <div class="summary-row">
                        <span>KDV:</span>
                        <span id="tax">0.00 TL</span>
                    </div>
                    <div class="summary-row">
                        <span>Indirim:</span>
                        <span id="discount">0.00 TL</span>
                    </div>
                    <div class="summary-row total">
                        <span>TOPLAM:</span>
                        <span id="total">0.00 TL</span>
                    </div>
                </div>
                <div class="cart-actions">
                    <button class="btn btn-clear" onclick="clearCart()">
                        <i class="fa fa-trash"></i> Temizle
                    </button>
                    <button class="btn btn-hold" onclick="holdOrder()">
                        <i class="fa fa-clock-o"></i> Beklet
                    </button>
                    <button class="btn btn-pay" onclick="processPayment()">
                        <i class="fa fa-credit-card"></i> Ode
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="window-statusbar">
            <span>Kasiyer: <strong id="cashier-name">-</strong></span>
            <span>Kasa: <strong id="till-name">Kasa 1</strong></span>
            <span id="status-time"></span>
        </div>
    </div>

    <script src="../assets/dist/js/bundle.min.js"></script>
    <script>
        // Global degiskenler
        var API_PORT = null;
        var API_BASE = null;
        var searchTimeout = null;
        var cart = [];
        var allDrugsList = [];

        // Sayfa yuklenir yuklenmez calis
        (function() {
            var grid = document.getElementById('products-grid');
            if (grid) {
                grid.innerHTML = '<div style="padding:20px;text-align:center;">Port aranıyor...</div>';
            }

            // Parent'tan port al
            var port = null;
            try {
                if (window.parent && window.parent.API_PORT) {
                    port = window.parent.API_PORT;
                }
            } catch(e) {}

            // URL'den port al
            if (!port) {
                try {
                    var urlParams = new URLSearchParams(window.location.search);
                    port = urlParams.get('port');
                } catch(e) {}
            }

            if (port) {
                API_PORT = port;
                API_BASE = 'http://localhost:' + port;
                if (grid) grid.innerHTML = '<div style="padding:20px;text-align:center;">Port bulundu: ' + port + ', ilaçlar yükleniyor...</div>';
                loadDrugs();
            } else {
                // Port taramasi yap
                scanPorts();
            }
        })();

        // Port taramasi
        function scanPorts() {
            var grid = document.getElementById('products-grid');
            var ports = [51522, 51480, 51851, 59849, 51295, 52000, 53000, 54000, 55000, 56000, 57000, 58000, 59000, 60000];
            var found = false;
            var checked = 0;

            for (var i = 50000; i <= 60000; i += 500) {
                ports.push(i);
            }

            ports.forEach(function(p) {
                if (found) return;

                var xhr = new XMLHttpRequest();
                xhr.timeout = 500;
                xhr.onreadystatechange = function() {
                    if (found) return;
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        found = true;
                        API_PORT = p;
                        API_BASE = 'http://localhost:' + p;
                        if (grid) grid.innerHTML = '<div style="padding:20px;text-align:center;color:green;">Port bulundu: ' + p + '</div>';
                        loadDrugs();
                    }
                };
                xhr.onerror = function() { checked++; };
                xhr.ontimeout = function() { checked++; };
                try {
                    xhr.open('GET', 'http://localhost:' + p + '/api/drugs/stats', true);
                    xhr.send();
                } catch(e) { checked++; }
            });

            // 5 saniye sonra hala bulunamadiysa hata goster
            setTimeout(function() {
                if (!found && grid) {
                    grid.innerHTML = '<div style="padding:20px;text-align:center;color:red;">Sunucu bulunamadı!</div>';
                }
            }, 5000);
        }

        // Ilaclari yukle
        function loadDrugs() {
            var grid = document.getElementById('products-grid');
            if (!API_BASE) {
                if (grid) grid.innerHTML = '<div style="padding:20px;color:red;">API tanımlı değil</div>';
                return;
            }

            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            allDrugsList = JSON.parse(xhr.responseText);
                            renderProducts(allDrugsList.slice(0, 500));
                            var searchInput = document.getElementById('product-search');
                            if (searchInput) {
                                searchInput.placeholder = 'İlaç ara (' + allDrugsList.length + ' ilaç yüklendi)...';
                            }
                            // Parol var mı kontrol et
                            var parolCount = 0;
                            for (var i = 0; i < allDrugsList.length; i++) {
                                if (allDrugsList[i].name && allDrugsList[i].name.toLowerCase().indexOf('parol') >= 0) {
                                    parolCount++;
                                }
                            }
                            console.log('Toplam ilaç: ' + allDrugsList.length + ', PAROL içeren: ' + parolCount);
                        } catch(e) {
                            if (grid) grid.innerHTML = '<div style="padding:20px;color:red;">JSON parse hatası: ' + e.message + '</div>';
                        }
                    } else {
                        if (grid) grid.innerHTML = '<div style="padding:20px;color:red;">API hatası: ' + xhr.status + '</div>';
                    }
                }
            };
            xhr.onerror = function() {
                if (grid) grid.innerHTML = '<div style="padding:20px;color:red;">Bağlantı hatası</div>';
            };
            xhr.open('GET', API_BASE + '/api/drugs/all?limit=50000', true);
            xhr.send();
        }

        // Yeni POS penceresi ac
        function openNewPOS() {
            try {
                if (window.parent && window.parent.MDI) {
                    window.parent.MDI.createWindow('pos');
                }
            } catch(e) {}
        }

        // Sepet islemleri
        function clearCart() {
            cart = [];
            renderCart();
            updateTotals();
        }

        function holdOrder() {
            if (cart.length === 0) { alert('Sepet bos!'); return; }
            alert('Siparis beklemeye alindi');
            clearCart();
        }

        function processPayment() {
            if (cart.length === 0) { alert('Sepet bos!'); return; }
            alert('Odeme islemi baslatiliyor...');
        }

        function renderCart() {
            var container = document.getElementById('cart-items');
            var emptyCart = document.getElementById('empty-cart');
            var cartCount = document.getElementById('cart-count');
            if (!container) return;

            container.innerHTML = '';
            if (cart.length === 0) {
                if (emptyCart) { emptyCart.style.display = 'block'; container.appendChild(emptyCart); }
            } else {
                if (emptyCart) emptyCart.style.display = 'none';
                for (var i = 0; i < cart.length; i++) {
                    var item = cart[i];
                    var div = document.createElement('div');
                    div.className = 'cart-item';
                    div.innerHTML = '<div class="qty">' + item.qty + 'x</div>' +
                        '<div class="info"><div class="name">' + item.name + '</div>' +
                        '<div class="price">' + parseFloat(item.price || 0).toFixed(2) + ' TL</div></div>' +
                        '<div class="total">' + (parseFloat(item.price || 0) * item.qty).toFixed(2) + ' TL</div>' +
                        '<div class="remove" onclick="removeFromCart(' + i + ')"><i class="fa fa-times"></i></div>';
                    container.appendChild(div);
                }
            }
            if (cartCount) cartCount.textContent = cart.length;
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
            updateTotals();
        }

        // Saat guncelle
        function updateTime() {
            var now = new Date();
            var el = document.getElementById('status-time');
            if (el) el.textContent = now.toLocaleTimeString('tr-TR');
        }
        setInterval(updateTime, 1000);

        // Arama input event
        document.addEventListener('DOMContentLoaded', function() {
            var searchInput = document.getElementById('product-search');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    var query = e.target.value.trim().toLowerCase();
                    if (searchTimeout) clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function() { filterDrugs(query); }, 150);
                });
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        var firstCard = document.querySelector('.product-card');
                        if (firstCard) firstCard.click();
                    }
                });
            }
        });

        // Listeyi filtrele
        function filterDrugs(query) {
            if (!query || query.length === 0) {
                renderProducts(allDrugsList.slice(0, 500));
                return;
            }

            query = query.toLowerCase();
            var filtered = [];
            for (var i = 0; i < allDrugsList.length; i++) {
                var drug = allDrugsList[i];
                var name = (drug.name || '').toLowerCase();
                var barcode = (drug.barcode || '').toString();
                var firm = (drug.firmName || '').toLowerCase();
                if (name.indexOf(query) >= 0 || barcode.indexOf(query) === 0 || firm.indexOf(query) >= 0) {
                    filtered.push(drug);
                }
            }

            var grid = document.getElementById('products-grid');
            if (filtered.length === 0) {
                if (grid) grid.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">Sonuç bulunamadı<br><small>Toplam ' + allDrugsList.length + ' ilaç içinde "' + query + '" bulunamadı</small></div>';
            } else {
                renderProducts(filtered.slice(0, 500));
            }
        }

        // Urunleri liste olarak goster
        function renderProducts(products) {
            var grid = document.getElementById('products-grid');
            if (!grid) return;

            // Liste tablosu olustur
            var html = '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<thead><tr style="background:#1976d2;color:white;position:sticky;top:0;">';
            html += '<th style="padding:8px;text-align:left;">İlaç Adı</th>';
            html += '<th style="padding:8px;text-align:left;width:150px;">Firma</th>';
            html += '<th style="padding:8px;text-align:center;width:60px;">Reçete</th>';
            html += '<th style="padding:8px;text-align:right;width:80px;">Fiyat</th>';
            html += '</tr></thead><tbody>';

            for (var i = 0; i < products.length; i++) {
                var p = products[i];
                var bgColor = i % 2 === 0 ? '#fff' : '#f5f5f5';
                var badgeColor = '#4caf50';
                if (p.prescriptionType === 'Mor') badgeColor = '#9c27b0';
                else if (p.prescriptionType === 'Kirmizi') badgeColor = '#f44336';
                else if (p.prescriptionType === 'Turuncu') badgeColor = '#ff9800';

                html += '<tr style="background:' + bgColor + ';cursor:pointer;" onclick="addToCartByIndex(' + i + ')" onmouseover="this.style.background=\'#e3f2fd\'" onmouseout="this.style.background=\'' + bgColor + '\'">';
                html += '<td style="padding:6px 8px;">' + (p.name || '') + '</td>';
                html += '<td style="padding:6px 8px;color:#666;">' + (p.firmName ? p.firmName.substring(0,25) : '') + '</td>';
                html += '<td style="padding:6px 8px;text-align:center;"><span style="background:' + badgeColor + ';color:white;padding:2px 6px;border-radius:3px;font-size:10px;">' + (p.prescriptionType || 'N') + '</span></td>';
                var priceVal = parseFloat(p.price || 0);
                html += '<td style="padding:6px 8px;text-align:right;font-weight:bold;color:' + (priceVal > 0 ? '#1976d2' : '#999') + ';">' + (priceVal > 0 ? priceVal.toFixed(2) + ' TL' : '-') + '</td>';
                html += '</tr>';
            }

            html += '</tbody></table>';
            grid.innerHTML = html;

            // Gosterilen urunleri kaydet
            window.displayedProducts = products;
        }

        // Index ile sepete ekle
        function addToCartByIndex(index) {
            if (window.displayedProducts && window.displayedProducts[index]) {
                addToCart(window.displayedProducts[index]);
            }
        }

        function addToCart(product) {
            var existing = null;
            for (var i = 0; i < cart.length; i++) {
                if (cart[i]._id === product._id) {
                    existing = cart[i];
                    break;
                }
            }
            if (existing) {
                existing.qty++;
            } else {
                var newItem = {};
                for (var key in product) {
                    newItem[key] = product[key];
                }
                newItem.qty = 1;
                cart.push(newItem);
            }
            renderCart();
            updateTotals();
        }

        function updateTotals() {
            var subtotal = 0;
            for (var i = 0; i < cart.length; i++) {
                subtotal += parseFloat(cart[i].price || 0) * cart[i].qty;
            }
            var tax = subtotal * 0.18;
            var total = subtotal + tax;

            var el1 = document.getElementById('subtotal');
            var el2 = document.getElementById('tax');
            var el3 = document.getElementById('total');
            if (el1) el1.textContent = subtotal.toFixed(2) + ' TL';
            if (el2) el2.textContent = tax.toFixed(2) + ' TL';
            if (el3) el3.textContent = total.toFixed(2) + ' TL';
        }

        function filterByCategory(categoryId) {
            // Kategoriye gore filtrele
        }
    </script>
</body>
</html>
