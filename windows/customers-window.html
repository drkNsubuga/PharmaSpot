<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Musteri Listesi</title>
    <link href="../assets/dist/css/bundle.min.css" rel="stylesheet" type="text/css" />
    <link href="../assets/css/tebeos-theme.css" rel="stylesheet" type="text/css" />
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        .window-container { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .window-toolbar { background: linear-gradient(180deg, #fafafa 0%, #e0e0e0 100%); border-bottom: 1px solid #bdbdbd; padding: 8px 10px; display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
        .window-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 10px; background: #f5f5f5; }
        .search-row { display: flex; gap: 10px; margin-bottom: 10px; flex-shrink: 0; }
        .search-row input { flex: 1; padding: 8px 12px; border: 1px solid #bdbdbd; border-radius: 4px; }
        .table-container { flex: 1; overflow: auto; background: white; border: 1px solid #bdbdbd; border-radius: 4px; }
        .window-statusbar { background: linear-gradient(180deg, #e0e0e0 0%, #bdbdbd 100%); padding: 4px 10px; font-size: 11px; color: #666; display: flex; justify-content: space-between; border-top: 1px solid #9e9e9e; flex-shrink: 0; }
    </style>
</head>
<body>
    <div class="window-container">
        <div class="window-toolbar">
            <button class="tebeos-btn tebeos-btn-success" onclick="openNewCustomer()">
                <i class="fa fa-user-plus"></i> Yeni Musteri
            </button>
            <button class="tebeos-btn tebeos-btn-primary" onclick="refreshCustomers()">
                <i class="fa fa-refresh"></i> Yenile
            </button>
        </div>

        <div class="window-content">
            <div class="search-row">
                <input type="text" id="search" placeholder="Musteri ara (isim, telefon, email)..." onkeyup="filterCustomers()">
            </div>
            <div class="table-container">
                <table class="tebeos-table">
                    <thead>
                        <tr>
                            <th>Musteri Adi</th>
                            <th>Telefon</th>
                            <th>Email</th>
                            <th>Adres</th>
                            <th>Toplam Alisveris</th>
                            <th>Bakiye</th>
                            <th>Islem</th>
                        </tr>
                    </thead>
                    <tbody id="customers-body"></tbody>
                </table>
            </div>
        </div>

        <div class="window-statusbar">
            <span>Toplam: <strong id="customer-count">0</strong> musteri</span>
        </div>
    </div>

    <script src="../assets/dist/js/bundle.min.js"></script>
    <script>
        const { ipcRenderer } = require('electron');
        let allCustomers = [];

        function openNewCustomer() { ipcRenderer.send('open-window', 'new-customer'); }
        function refreshCustomers() { loadCustomers(); }

        function loadCustomers() {
            fetch('http://localhost:52484/api/customer')
                .then(res => res.json())
                .then(data => {
                    allCustomers = data;
                    renderCustomers(data);
                })
                .catch(err => console.error('Hata:', err));
        }

        function renderCustomers(customers) {
            const tbody = document.getElementById('customers-body');
            tbody.innerHTML = '';
            customers.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${c.customer_name}</strong></td>
                    <td>${c.phone || '-'}</td>
                    <td>${c.email || '-'}</td>
                    <td>${c.address || '-'}</td>
                    <td>${parseFloat(c.total_purchases || 0).toFixed(2)} TL</td>
                    <td><span class="${(c.balance || 0) > 0 ? 'text-danger' : ''}">${parseFloat(c.balance || 0).toFixed(2)} TL</span></td>
                    <td>
                        <button class="btn btn-xs btn-primary" onclick="editCustomer(${c.id})"><i class="fa fa-edit"></i></button>
                        <button class="btn btn-xs btn-info" onclick="viewOrders(${c.id})"><i class="fa fa-list"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('customer-count').textContent = customers.length;
        }

        function filterCustomers() {
            const search = document.getElementById('search').value.toLowerCase();
            const filtered = allCustomers.filter(c =>
                c.customer_name.toLowerCase().includes(search) ||
                (c.phone && c.phone.includes(search)) ||
                (c.email && c.email.toLowerCase().includes(search))
            );
            renderCustomers(filtered);
        }

        function editCustomer(id) { alert('Musteri duzenle: ' + id); }
        function viewOrders(id) { alert('Siparisler: ' + id); }

        document.addEventListener('DOMContentLoaded', loadCustomers);
    </script>
</body>
</html>
